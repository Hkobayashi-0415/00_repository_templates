---
name: bug-investigation
description: 報告されたバグの根本原因を特定し、修正方針を明確にするスキル
---

# Bug Investigation

## 1. Purpose

バグレポートを受け取り、根本原因（Root Cause）を特定し、修正方針を明確にする。

**責務（1つ）**: 原因特定と修正方針の策定のみ。実際の修正実装は別スキル（implementation）の責務。

---

## 2. When to Use / When NOT to Use

### ✅ When to Use
- バグレポート/Issueを受け取った時
- 予期しない動作・エラーが発生した時
- 本番障害の調査時
- 再現性の低い問題の調査時

### ❌ When NOT to Use
- 原因が明白な場合（タイポ、設定ミス等）→ 直接修正
- 新機能の実装（バグではない）
- パフォーマンス改善（別スキル）
- セキュリティ監査（別スキル）

---

## 3. Inputs Required

| 項目 | 必須 | 説明 |
|------|:----:|------|
| 再現手順 | ✅ | バグを再現するための手順 |
| 期待動作 | ✅ | 本来あるべき動作 |
| 実際の動作 | ✅ | 現在の問題のある動作 |
| エラーログ | ◯ | スタックトレース、エラーメッセージ |
| 環境情報 | ◯ | OS、ブラウザ、バージョン等 |
| 発生頻度 | ◯ | 常に/時々/まれに |
| 影響範囲 | ◯ | 影響を受けるユーザー数・機能 |

---

## 4. Output Format (Markdown)

```markdown
# バグ調査レポート: <Issue ID / タイトル>

## 概要
| 項目 | 内容 |
|------|------|
| 報告日 | YYYY-MM-DD |
| 調査者 | <名前> |
| 重要度 | 🔴 Critical / 🟠 High / 🟡 Medium / 🟢 Low |
| ステータス | 調査完了 / 原因特定済 / 修正方針策定済 |

---

## 再現確認

### 再現手順
1. <手順1>
2. <手順2>
3. <手順3>

### 再現結果
- [ ] 再現成功 / [ ] 再現失敗 / [ ] 条件付き再現

### 再現環境
- OS: 
- Browser/Runtime:
- Version:

---

## 根本原因分析 (RCA)

### 直接原因
<何が起きているか>

### 根本原因
<なぜそれが起きるのか - Why×5で深掘り>

### 問題箇所
- ファイル: `path/to/file.ts`
- 行番号: L123-L145
- 関数/メソッド: `functionName()`

### コード抜粋
```typescript
// 問題のあるコード
```

---

## 影響範囲

- [ ] 本番環境に影響あり
- [ ] 他機能への波及: <機能名>
- [ ] データ破損の可能性: あり/なし
- [ ] セキュリティリスク: あり/なし

---

## 修正方針

### 推奨アプローチ
<修正方法の説明>

### 変更対象
| ファイル | 変更内容 |
|----------|----------|
| `path/to/file.ts` | <変更内容> |

### 代替案
- 案A: <説明> - メリット/デメリット
- 案B: <説明> - メリット/デメリット

### テスト観点
- [ ] <テスト1>
- [ ] <テスト2>

---

## 再発防止策

- [ ] <防止策1>
- [ ] <防止策2>

---

## 次のアクション
- [ ] 修正実装（担当: ）
- [ ] コードレビュー
- [ ] テスト
- [ ] デプロイ
```

---

## 5. Procedure (Step-by-Step)

```
┌─────────────────────────────────────────────────────────────┐
│ Step 1: 情報収集                                            │
│   □ バグレポートを読み、要点を把握                          │
│   □ 再現手順・期待動作・実際の動作を確認                    │
│   □ 関連ログ・エラーメッセージを収集                        │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 2: 再現確認                                            │
│   □ 報告された手順でバグを再現                              │
│   □ 再現できない場合、条件を変えて試行                      │
│   □ 再現環境を記録                                          │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 3: 問題箇所の特定                                      │
│   □ ログ・スタックトレースを追跡                            │
│   □ 二分探索法で範囲を絞り込む                              │
│   □ 関連コードを読み、問題箇所を特定                        │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 4: 根本原因分析（Why×5）                               │
│   □ 「なぜ？」を5回繰り返す                                 │
│   □ 直接原因と根本原因を区別                                │
│   □ 仮説を立て、検証                                        │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 5: 影響範囲の評価                                      │
│   □ 他機能への影響を確認                                    │
│   □ データ整合性への影響を確認                              │
│   □ セキュリティリスクを評価                                │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 6: 修正方針の策定                                      │
│   □ 複数の修正案を検討                                      │
│   □ メリット・デメリットを比較                              │
│   □ 推奨アプローチを決定                                    │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 7: レポート作成                                        │
│   □ 調査結果をレポートにまとめる                            │
│   □ 再発防止策を提案                                        │
│   □ 次のアクションを明記                                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. Definition of Done (DoD)

- [ ] バグが再現できる（または再現条件を特定）
- [ ] 根本原因が特定されている
- [ ] 問題箇所（ファイル・行番号）が明確
- [ ] 修正方針が策定されている
- [ ] 影響範囲が評価されている
- [ ] 調査レポートがドキュメント化されている

---

## 7. Resources / References

| ファイル | 説明 |
|----------|------|
| `resources/rca-template.md` | 根本原因分析テンプレート |
| `resources/why5-guide.md` | Why×5分析ガイド |
| `scripts/log-collector.ps1` | ログ収集スクリプト（将来用） |
| `templates/bug-report-template.md` | バグレポートテンプレート |

---

## 8. Example Prompts

### Example 1: エラー調査
```
@bug-investigation
ログイン時に500エラーが発生する問題を調査してください。

再現手順:
1. ログインページにアクセス
2. メールアドレス「test@example.com」を入力
3. パスワード「password123」を入力
4. ログインボタンをクリック

期待動作: ダッシュボードにリダイレクト
実際の動作: 500 Internal Server Error

エラーログ: logs/error-2024-01-17.log
```

### Example 2: 表示崩れ
```
@bug-investigation
iOSでヘッダーメニューが表示されない問題を調査してください。

再現環境: iPhone 14, iOS 17.2, Safari
再現頻度: 常に
発生画面: 全ページのヘッダー
```

### Example 3: 間欠的エラー
```
@bug-investigation
「時々」決済処理がタイムアウトする問題を調査してください。

発生頻度: 約5%のトランザクション
発生時間帯: 特定なし（ランダム）
エラーメッセージ: "Gateway timeout"
```
