---
name: code-review
description: コードの品質・保守性・セキュリティを確保するレビュースキル
---

# Code Review

## 1. Purpose

プルリクエストやコード差分をレビューし、品質を確保する。バグの早期発見、知識共有、コード品質の維持向上に貢献する。

**責務（1つ）**: コードの品質評価とフィードバックのみ。修正実装は別スキル（implementation）の責務。

---

## 2. When to Use / When NOT to Use

### ✅ When to Use
- プルリクエストがレビュー待ちの時
- マージ前の最終確認時
- ペアプログラミングでのリアルタイムレビュー
- コード品質の定期監査時

### ❌ When NOT to Use
- 自動化ツール（Linter/Formatter）で検出可能な問題のみの場合
- 設計レビュー（アーキテクチャの議論は別スキル）
- ドキュメントのみの変更（内容確認は別途）

---

## 3. Inputs Required

| 項目 | 必須 | 説明 |
|------|:----:|------|
| コード差分 | ✅ | PR URL、diff、または変更ファイル |
| 変更の目的 | ✅ | 何を達成するための変更か |
| 関連Issue | ◯ | 対応するIssue番号 |
| 設計ドキュメント | ◯ | 関連する設計書 |
| コーディング規約 | ◯ | プロジェクトのスタイルガイド |
| 重点確認項目 | ◯ | 特に確認してほしいポイント |

---

## 4. Output Format (Markdown)

```markdown
# コードレビュー: PR #<番号> - <タイトル>

## 概要
| 項目 | 内容 |
|------|------|
| レビュー日 | YYYY-MM-DD |
| レビュアー | <名前> |
| 変更規模 | +X/-Y lines |
| リスク評価 | 🔴 High / 🟠 Medium / 🟢 Low |

---

## 判定

- [x] ✅ **Approve** - マージ可能
- [ ] 🔄 **Request Changes** - 修正必要
- [ ] 💬 **Comment** - 議論が必要

---

## 必須修正 (🔴 Must Fix)

### 1. [ファイル名:行番号] <問題のタイトル>
**問題**: <問題の説明>
**理由**: <なぜ問題なのか>
**修正案**:
```typescript
// 修正後のコード
```

---

## 推奨修正 (🟡 Should Fix)

### 1. [ファイル名:行番号] <改善のタイトル>
**現状**: <現在のコード/状態>
**提案**: <改善案>
**理由**: <改善することのメリット>

---

## 検討事項 (🔵 Consider)

- <検討してほしい点>

---

## 良い点 (🟢 Good)

- <肯定的フィードバック>
- <学びになった点>

---

## 確認質問

- [ ] Q1: <確認したい点>
- [ ] Q2: <確認したい点>

---

## チェックリスト

### 機能
- [x] 要件を満たしている
- [x] エッジケースが考慮されている

### 品質
- [x] コードが読みやすい
- [x] 命名が適切
- [ ] コメントが十分（TODO: 要確認）

### テスト
- [x] テストが追加されている
- [x] テストがパスしている

### セキュリティ
- [x] 入力値が検証されている
- [x] 機密情報がハードコードされていない
```

---

## 5. Procedure (Step-by-Step)

```
┌─────────────────────────────────────────────────────────────┐
│ Step 1: コンテキスト理解                                    │
│   □ PRの説明・目的を読む                                   │
│   □ 関連Issueを確認                                        │
│   □ 変更の全体像を把握                                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 2: 全体レビュー（俯瞰）                                │
│   □ 変更ファイル一覧を確認                                  │
│   □ 変更規模を把握（+/-行数）                               │
│   □ アーキテクチャへの影響を評価                            │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 3: 詳細レビュー                                        │
│   □ 各ファイルを順番にレビュー                              │
│   □ ロジックの正確性を確認                                  │
│   □ エッジケースを検討                                      │
│   □ エラーハンドリングを確認                                │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 4: 品質チェック                                        │
│   □ 命名は適切か                                            │
│   □ コードは読みやすいか                                    │
│   □ DRY原則に従っているか                                   │
│   □ 複雑すぎる箇所はないか                                  │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 5: セキュリティチェック                                │
│   □ 入力値の検証はあるか                                    │
│   □ SQLインジェクション対策                                  │
│   □ XSS対策                                                 │
│   □ 認証・認可は適切か                                      │
│   □ 機密情報の取り扱い                                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 6: テスト確認                                          │
│   □ テストが追加されているか                                │
│   □ テストカバレッジは十分か                                │
│   □ エッジケースのテストはあるか                            │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 7: フィードバック整理                                  │
│   □ Must Fix / Should Fix / Consider に分類                 │
│   □ 良い点も記載（ポジティブフィードバック）                │
│   □ 判定（Approve / Request Changes）を決定                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. Definition of Done (DoD)

- [ ] 全変更ファイルをレビュー済み
- [ ] 重大な問題（Must Fix）は指摘済み
- [ ] フィードバックは具体的かつ建設的
- [ ] セキュリティチェックを実施済み
- [ ] Approve / Request Changes を決定済み
- [ ] 良い点も1つ以上記載

---

## 7. Resources / References

| ファイル | 説明 |
|----------|------|
| `resources/review-checklist.md` | レビューチェックリスト |
| `resources/security-checklist.md` | セキュリティチェックリスト |
| `resources/common-issues.md` | よくある指摘事項集 |
| `templates/review-template.md` | レビューコメントテンプレート |

---

## 8. Example Prompts

### Example 1: 通常レビュー
```
@code-review
PR #123 をレビューしてください。

目的: ユーザー認証機能の追加
変更ファイル: src/auth/*.ts
重点確認: セキュリティ（パスワードハッシュ、JWT検証）
```

### Example 2: セキュリティ重視
```
@code-review
以下の変更をセキュリティ観点でレビューしてください。

対象: src/api/payment.ts
確認ポイント:
- SQLインジェクション対策
- 入力値検証
- 認証・認可
```

### Example 3: リファクタリング
```
@code-review
リファクタリングPRをレビューしてください。

目的: UserService の責務分割
確認ポイント:
- 動作が変わっていないこと
- テストがパスすること
- 可読性の向上
```
